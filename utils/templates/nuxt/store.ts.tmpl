import { defineStore } from 'pinia'
import type { {{.Model}}, Create{{.Model}}Input, Update{{.Model}}Input, {{.Model}}FilterInput, {{.Model}}SortInput } from '../types/{{.ModelSnake}}'

interface {{.Model}}State {
  {{.VarPlural}}: {{.Model}}[]
  current{{.Model}}: {{.Model}} | null
  loading: boolean
  error: string | null
  filters: {{.Model}}FilterInput
  sort: {{.Model}}SortInput
  pagination: {
    total: number
    page: number
    limit: number
    totalPages: number
  }
}

export const use{{.Plural}}Store = defineStore('{{.PluralSnake}}', {
  state: (): {{.Model}}State => ({
    {{.VarPlural}}: [],
    current{{.Model}}: null,
    loading: false,
    error: null,
    filters: {},
    sort: {
      field: 'created_at',
      order: 'desc'
    },
    pagination: {
      total: 0,
      page: 1,
      limit: 10,
      totalPages: 0,
    },
  }),

  getters: {
    get{{.Model}}ById: (state) => (id: number) => {
      return state.{{.VarPlural}}.find(item => item.id === id)
    },
  },

  actions: {
    async fetch{{.Plural}}(page = 1, limit = 10) {
      this.loading = true
      this.error = null

      try {
        const api = useApi()
        const params: Record<string, string> = {
          page: page.toString(),
          limit: limit.toString(),
          sort_by: this.sort.field,
          sort_order: this.sort.order,
        }

        // Add filters if they exist
        Object.entries(this.filters).forEach(([key, value]) => {
          if (value !== undefined && value !== null && value !== '') {
            params[key] = String(value)
          }
        })

        const queryString = new URLSearchParams(params).toString()

        const response = await api.get<{
          data: {{.Model}}[]
          pagination: {
            total: number
            page: number
            page_size: number
            total_pages: number
          }
        }>(`/{{.PluralSnake}}?${queryString}`)

        this.{{.VarPlural}} = Array.isArray(response.data) ? response.data : []
        this.pagination = {
          total: response.pagination?.total || 0,
          page: response.pagination?.page || 1,
          limit: response.pagination?.page_size || 10,
          totalPages: response.pagination?.total_pages || 0,
        }
      } catch (error: any) {
        this.error = error.message || 'Failed to fetch {{.PluralLower}}'
        throw error
      } finally {
        this.loading = false
      }
    },

    async fetch{{.Model}}(id: number) {
      this.loading = true
      this.error = null

      try {
        const api = useApi()
        const response = await api.get<{{.Model}}>(`/{{.PluralSnake}}/${id}`)
        this.current{{.Model}} = response
        return response
      } catch (error: any) {
        this.error = error.message || 'Failed to fetch {{.ModelLower}}'
        throw error
      } finally {
        this.loading = false
      }
    },

    async create{{.Model}}(data: Create{{.Model}}Input) {
      this.loading = true
      this.error = null

      try {
        const api = useApi()
        const cleanData: any = { ...data }

        const response = await api.post<{{.Model}}>('/{{.PluralSnake}}', cleanData)

        this.{{.VarPlural}}.unshift(response)
        return response
      } catch (error: any) {
        this.error = error.message || 'Failed to create {{.ModelLower}}'
        throw error
      } finally {
        this.loading = false
      }
    },

    async update{{.Model}}(id: number, data: Update{{.Model}}Input) {
      this.loading = true
      this.error = null

      try {
        const api = useApi()
        const cleanData: any = { ...data }

        const response = await api.put<{{.Model}}>(`/{{.PluralSnake}}/${id}`, cleanData)

        const index = this.{{.VarPlural}}.findIndex(p => p.id === id)
        if (index !== -1) {
          this.{{.VarPlural}}[index] = response
        }

        if (this.current{{.Model}}?.id === id) {
          this.current{{.Model}} = response
        }

        return response
      } catch (error: any) {
        this.error = error.message || 'Failed to update {{.ModelLower}}'
        throw error
      } finally {
        this.loading = false
      }
    },

    async delete{{.Model}}(id: number) {
      this.loading = true
      this.error = null

      try {
        const api = useApi()
        await api.delete(`/{{.PluralSnake}}/${id}`)

        this.{{.VarPlural}} = this.{{.VarPlural}}.filter(p => p.id !== id)

        if (this.current{{.Model}}?.id === id) {
          this.current{{.Model}} = null
        }
      } catch (error: any) {
        this.error = error.message || 'Failed to delete {{.ModelLower}}'
        throw error
      } finally {
        this.loading = false
      }
    },

    setFilters(filters: {{.Model}}FilterInput) {
      this.filters = filters
    },

    setSort(sort: {{.Model}}SortInput) {
      this.sort = sort
    },

    clearFilters() {
      this.filters = {}
    },

    reset() {
      this.$reset()
    },
  },
})
